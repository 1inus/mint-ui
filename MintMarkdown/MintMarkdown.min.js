function MintMarkdown(t,e,i,a,n){var s=this;s.setting=$.extend({insertImg:{uploadUrl:"",loadUrl:"",deleteUrl:"",imgDataFilter:function(){}}},a),s.prevOn=n,s.tool=$('<ul class="mint_markdown_toolbar"/>').appendTo($($(t)[0]));var l=$($(e)[0]);s.input=$('<textarea class="mint_markdown_input" spellcheck="false" autocomplete="off"></textarea>').html(l.html()),s.preview=$('<div class="mint_markdown_preview article"></div>').appendTo(l),s.prev(),s.body=$('<div class="mint_markdown_body">').append($("<div class='input_wraper'/>").append(s.input)).append($("<div class='preview_wraper'/>").append(s.preview)).appendTo(l.empty()),s.inputWraper=s.input.parent(),s.prevOn&&s.body.addClass("preview_on"),s.input.on("mouseup keyup mouseleave",function(){s.saveScene()}).on("input propertychange",function(){s.prev()}),s.tool.delegate("li","click",function(t){var e=$(this),i=e.attr("op"),a=e.attr("fn"),n=e.attr("val");i&&(s.restoreScene(),/fb-/.test(i)?s.exeCmd("formatBlock",!1,"<"+i.substr(3)+">"):(n||(n=null),s.exeCmd(i,!1,n))),$(t.target).is(".tool")&&a&&s.tools[a].fn(s,e,t)}),function(){i||(i=["undo","redo","|","insertImg","preview","leftRight","rightLeft"]);var t,e,a={};$.each(i,function(t,e){"|"!=e?a[e]=s.tools[e]:a["split"+t]={type:"0"}});for(var n in a)t=a[n],"0"==t.type?e=$('<li class="split"></li>'):(e=$('<li class="tool"></li>').attr("title",t.title).addClass(n),t.fn?e.attr("fn",n):t.isFB?e.attr("op","fb-"+n):e.attr("op",n),t.init&&t.init(s,e)),s.tool.append(e.attr("unselectable","on"))}()}!function(){var t=$("script").last().attr("src");t=t.replace(t.substring(t.lastIndexOf("/")+1),""),$("head:first").append($('<link rel="stylesheet"/>').attr("href",t+"css/style.css")).append($('<link rel="stylesheet"/>').attr("href",t+"css/article.css")).append($('<link rel="stylesheet"/>').attr("href",t+"lib/highlight/css/atelier-dune.light.min.css")).append($("<script/>").attr("src",t+"lib/highlight/highlight.min.js")).append($("<script/>").attr("src",t+"lib/marked.min.js"))}(),MintMarkdown.prototype={html:function(){for(var t=$("<div>").html(marked(editor.input.val())),e=1;8>e;e++)t.find("h"+e).each(function(t,i){i=$(i),i.attr("id","h"+e+"_"+t)});return t.html()},getCatalogue:function(){var t=$("<div>").html(this.html()).find("h1,h2,h3,h4,h5,h6,h7");return t.each(function(t,e){e=$(e),e.attr("for",e.attr("id")).removeAttr("id")}),$("<div/>").append(t).html().trim()},prev:function(){if(this.prevOn){var t=$(marked(this.input.val()));t.find("code").each(function(t,e){hljs.highlightBlock(e)}),this.preview.html(t)}},text:function(t){return void 0==t||""==t?this.input.val():(this.input.val(t),void this.prev())},exeCmd:function(t,e,i){this.RG&&(this.restoreScene(),document.execCommand(t,e,i),this.saveScene())},insertTxt:function(t){if(void 0!=t&&""!=t){var e=this.RG,i=this.input;if(e){if(e.select)e.text=t;else{var a=i.val();i.val(a.substring(0,e.start)+t+a.substring(e.end)),i.selectionStart=e.start+t.length,i.selectionEnd=e.start+t.length}this.saveScene(),this.prev()}}},restoreScene:function(){if(this.RG){var t=this.input[0];if("selectionStart"in t){var e=this.RG;t.selectionStart=e.start,t.selectionEnd=e.end,t.focus()}else this.RG.select()}},saveScene:function(){var t,e=this.input[0];if("selectionStart"in e)t={start:e.selectionStart,end:e.selectionEnd},this.RG=t;else{var t=document.selection.createRange();t.parentElement()===e&&(this.RG=t)}},tools:{undo:{title:"向后撤销一步"},redo:{title:"向前撤销一步"},insertImg:{title:"上传图片",init:function(t,e){function i(t){var e=t.type;if(e.indexOf("image")>-1){var i=new FileReader;i.onload=function(){var e=$('<li class="new"><div class="delete" title="删除">×</div><div class="img"><img src="'+this.result+'"/></div><div class="img_name" title="'+t.name+'">'+t.name+"</div></li>");r.prepend(e.data("file",t)),p+=t.size,u+=1,n()},i.readAsDataURL(t)}}function a(t){r.children(".new").remove(),$.each(t,function(t,e){r.prepend($('<li><div class="delete" title="删除">×</div><div class="img"><img src="'+e.src+'"/></div><div class="img_name" title="'+e.name+'">'+e.name+"</div></li>").data("data",e))})}function n(){c.find(".file_info").html(u+" 张新图片，共 "+Math.floor(p/1048576)+" MB")}var s=$('<div class="upload_dialog"><div class="image_upload_area"><ul class="images"></ul></div><div class="upload_tool"><div class="upload_process"><div class="process_bar"><span class="file_info"></span><span class="upload_status"></span></div></div><input type="file" accept="image/*"/><button class="select_file">选择新图片</button><button class="do_upload">上传新图片</button></div></div>'),l=s.children(".image_upload_area"),r=l.children(".images"),o=t.setting.insertImg,d=s.children(".upload_tool"),c=d.find(".process_bar"),p=0,u=0,v=d.children("input");s.on("mousedown",function(){return!1}),l.on("dragenter",function(t){t.stopPropagation(),t.preventDefault(),l.addClass("drop")}).on("dragleave dragend drop",function(t){t.stopPropagation(),t.preventDefault(),l.removeClass("drop")}).on("dragover",function(t){t.stopPropagation(),t.preventDefault()}).on("drop",function(t){var e=t.originalEvent.dataTransfer.files;0==p&&c.css("width",0).children().html(""),$.each(e,function(t,e){i(e)})}),v.change(function(){var t=v[0].files[0];null!=t&&t.type.indexOf("image")>-1&&i(t)}),d.children(".select_file").click(function(){v.click()}),d.children(".do_upload").click(function(){var t=r.find(".new");if(t.length>0){var e,i=new FormData;$.each(t,function(t,a){e=$(a).data("file"),i.append("imgs",e)});var n=new XMLHttpRequest;n.upload.addEventListener("progress",function(t){c.css("width",100*t.loaded/t.total+"%")},!1),$.ajax({url:o.uploadUrl,data:i,processData:!1,contentType:!1,type:"post",dataType:"json",xhr:function(){return n},success:function(t){data=o.imgDataFilter(t),c.children(".upload_status").html("- (成功上传"+data.length+"张图片)"),a(data),u=0,p=0}})}}),r.delegate("img","click",function(){$(this).parents("li:first").is(".new")||t.insertTxt("\n![Alt text]("+$(this).attr("src")+")")}).delegate(".delete","click",function(){var t=$(this).parent();if(t.is(".new")){var e=t.data("file");p-=e.size,u-=1,n(),t.remove()}else o.deleteUrl&&$.ajax({url:o.deleteUrl,data:t.data("data"),type:"post",dataType:"json",data:t.data("data"),success:function(){t.remove()}})});var f=new MintDialog({title:"<span style='font-family:微软雅黑;'>上传文件（把文件拖到虚线框内上传）</span>",body:s,modal:!1,moveable:!0,beforeClose:function(){return!0},onShow:function(){f.FIRST&&o.loadUrl&&$.ajax({url:o.loadUrl+"?"+(new Date).getTime(),type:"get",success:function(t){f.FIRST=!1,t=o.imgDataFilter(t),a(t)}})}});f.FIRST=!0,e.data("dialog",f)},fn:function(t,e){e.data("dialog").show()}},preview:{title:"预览",init:function(t,e){t.prevOn&&(e.addClass("active"),t.tool.addClass("preview_on"))},fn:function(t,e){t.body.is(".preview_on")?(t.body.removeClass("preview_on"),e.removeClass("active"),t.tool.removeClass("preview_on"),t.prevOn=!1):(t.body.addClass("preview_on"),e.addClass("active"),t.tool.addClass("preview_on"),t.prevOn=!0,t.prev())}},leftRight:{title:"左右布局",init:function(t,e){e.addClass("active")},fn:function(t,e){t.body.removeClass("left_right"),e.addClass("active").parent().find(".rightLeft").removeClass("active")}},rightLeft:{title:"右左布局",init:$.noop,fn:function(t,e){t.body.addClass("left_right"),e.addClass("active").parent().find(".leftRight").removeClass("active")}}}};